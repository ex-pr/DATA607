---
title: "Project 1"
author: "Daria Dubovskaia"

output: html_document
---

```{r setup, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(readr)
library(stringr)
library(dplyr)
library(tibble)
```
### 1. Introduction
In this project, you’re given a text file with chess tournament results where the information has some structure. Your 
job is to create an R Markdown file that generates a .CSV file (that could for example be imported into a SQL database) 
with the following information for all of the players: <br>
Player’s Name, Player’s State, Total Number of Points, Player’s Pre-Rating, and Average Pre Chess Rating of Opponents.

### 2. Load text file
The text file will be downloaded from the Github repository to csv file using read_csv function. read_csv is faster for large .csv files comparing to read.csv function as it imports data into R as a tibble. So it may be better be familiar to try to use it in this project.
```{r}
data <-read_csv(file = "https://raw.githubusercontent.com/ex-pr/DATA607/Project-1/7645617.txt",col_names = FALSE, show_col_types = FALSE)
```
By checking the data downloaded, we have 1 column with 196 rows. The final file should contain information about 64 players.
```{r}
summary(data)
head(data)
```
To make the work easy, I will remove column names as well as the last dashed line.

```{r}
data <- data %>%
  filter(!row_number() %in% c(1, 2, 3, 4, 196))
data
```
### 3. Format data
#### 3.1 Deframe data
As we see in our file each player takes 2 lines, so we need to take the information we need for each player from these two lines and make it as one line for one player. To make it easy to work with, we will deframe the tibble and receive 196 strings of data.
```{r}
chess <- deframe(data)
head(chess)
```
#### 3.2 Removing - and |
Using code and libraries from the previous HW, we will treat our data as string. At this step, the main goal is to remove all | between future columns and dashes between future rows. <br>
As the first step, we will detect and delete dashes with a help from regular expressions.

```{r}
remove_ <- str_detect(chess, '^[-]{2,}$') 
chess <- chess[!remove_ == "TRUE"]
head(chess)
```
Next, we will substitute | and / with comma as it will help us to convert data into data frame.

```{r}
chess <- str_replace_all(chess, "[|/]",",")   
head(chess)
```

#### 3.3 Combining two rows and creating data frame
Combine two rows
```{r}
a <- c("")
for (i in seq(1, length(chess)-1, by = 2)){
   a <- c(a, paste(chess[i], chess[i+1], sep = "", collapse = NULL))
}
```
Create data frame from the strings of data.
```{r}
chess_final <- as.data.frame(do.call(rbind, strsplit(a, ",")), stringsAsFactors = FALSE)
head(chess_final)
```

#### 3.4 Format data frame
We will remove columns that we don't need for the assignment
```{r}
chess_final[12] <- list(NULL) 
chess_final[c(1,13:ncol(chess_final))] <- list(NULL) 
```
Rename columns.
```{r}
colnames(chess_final)[1] <- c("Name")
colnames(chess_final)[2] <- c("Total Number of Points")
colnames(chess_final)[3:9] <- c("R1","R2","R3","R4","R5","R6","R7")
colnames(chess_final)[10] <- c("State")
colnames(chess_final)[11] <- c("Pre_Rating")
```
We need to extract pre-rating for each player.
```{r}
chess_final$Pre_Rating <- str_sub(chess_final$Pre_Rating, 5, 8)
```

Remove letters from Round results.
```{r}
nm1 <- c("R1", "R2", "R3", "R4", "R5", "R6", "R7") 
chess_final[nm1]<-lapply(chess_final[nm1], gsub, pattern = "W ", replacement = "")
chess_final[nm1]<-lapply(chess_final[nm1], gsub, pattern = "L ", replacement = "")
chess_final[nm1]<-lapply(chess_final[nm1], gsub, pattern = "D ", replacement = "")
chess_final[nm1]<-lapply(chess_final[nm1], gsub, pattern = "U ", replacement = "")
chess_final[nm1]<-lapply(chess_final[nm1], gsub, pattern = "H ", replacement = "")
chess_final[nm1]<-lapply(chess_final[nm1], gsub, pattern = "X ", replacement = "")
```
If there are any empty (NA) spaces, we will substitute it with 0
```{r}
chess_final[is.na(chess_final)] <- 0  
```
We won't be able to calculate average if we don't transform data in columns 2:9 and 11 in to numbers.
```{r warning=FALSE, message=FALSE}
chess_final[c(2:9,11)] <- sapply((chess_final)[c(2:9,11)], as.numeric) 
chess_final[is.na(chess_final)] <- 0  
head(chess_final)
```


### 4 Calculating Average Pre-Chess Rating of Opponents
The average pre-rating of opponents  is calculated by using the pre-tournament opponents’ ratings and dividing by the total number of games played.
```{r}
total <- numeric(0)
opponents <- numeric(0)
avg_rate <- vector()
for (i in 1:length(chess_final$Pre_Rating)){
    player <- as.numeric(as.vector(chess_final[i,3:9])) 
    total <- sum(chess_final[player, "Pre_Rating"])
    opponents <-  sum(chess_final[i,c(3:9)]!=0) # number of opponents for each player, if no opponents than 0
    avg_rate[i] <- round(total / opponents, digits = 0)   
    }
chess_final$Avg_Pre_Rate <- avg_rate
head(chess_final)
```
### 5. Creating csv file
For the final csv file, we will use columns Name, State, Total Number of Points,Pre-Rating, and Average Pre Chess Rating of Opponents as it is asked by the assignment.
```{r}
chess_final <- chess_final[,c(1,10,2,11,12)]
head(chess_final)
```

```{r}
write.csv(chess_final, file = "Chess.csv")
```