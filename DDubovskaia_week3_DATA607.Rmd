---
title: "Assignment â€“ SQL and R"
author: "Daria Dubovskaia"
output:
  html_document: default
  pdf_document: default
---

Choose six recent popular movies. Ask at least five people that you know (friends, family, classmates, imaginary
friends if necessary) to rate each of these movies that they have seen on a scale of 1 to 5. Take the results
(observations) and store them in a SQL database of your choosing. Load the information from the SQL database
into an R dataframe.

### 1.Generate database using SQL
The database to store the table with names, movies and ratings is to be created using SQL.
```{mysql eval=FALSE}

CREATE DATABASE rating;

USE rating;

CREATE TABLE rating (
 name_response varchar(100),
 movie_name varchar(100),
 rating int
);

INSERT INTO rating 
VALUES 
-- ('Anna', 'MINIONS. THE RISE OF GRU', 3),
('Alex', 'MINIONS. THE RISE OF GRU', 2),
('Inna', 'MINIONS. THE RISE OF GRU', 4),
('Dan', 'MINIONS. THE RISE OF GRU', 3),
('Lucy', 'MINIONS. THE RISE OF GRU', NULL),

('Anna', 'JURASSIC WORLD DOMINION', 4),
('Alex', 'JURASSIC WORLD DOMINION', 3),
('Inna', 'JURASSIC WORLD DOMINION', NULL),
('Dan', 'JURASSIC WORLD DOMINION', 3),
('Lucy', 'JURASSIC WORLD DOMINION', 4),

('Anna', 'ROGUE ONE: A STAR WARS STORY', NULL),
('Alex', 'ROGUE ONE: A STAR WARS STORY', 5),
('Inna', 'ROGUE ONE: A STAR WARS STORY', 1),
('Dan', 'ROGUE ONE: A STAR WARS STORY', 3),
('Lucy', 'ROGUE ONE: A STAR WARS STORY', NULL),

('Anna', 'SPIDER-MAN: NO WAY HOME', 5),
('Alex', 'SPIDER-MAN: NO WAY HOME', 5),
('Inna', 'SPIDER-MAN: NO WAY HOME', 4),
('Dan', 'SPIDER-MAN: NO WAY HOME', 5),
('Lucy', 'SPIDER-MAN: NO WAY HOME', 4),

('Anna', 'ORPHAN: FIRST KILL', NULL),
('Alex', 'ORPHAN: FIRST KILL', 1),
('Inna', 'ORPHAN: FIRST KILL', NULL),
('Dan', 'ORPHAN: FIRST KILL', 2),
('Lucy', 'ORPHAN: FIRST KILL', NULL),

 ('Anna', 'ELVIS', 4),
('Alex', 'ELVIS', 3),
('Inna', 'ELVIS', 3),
('Dan', 'ELVIS', 4),
('Lucy', 'ELVIS', NULL);
```
### 2. Load database using R
To load SQL database using R, RMySQL library is used.
```{r setup, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(RMySQL)
library(dplyr)
```

```{r}
db = dbConnect(MySQL(), user='root', password = '336261', dbname='rating', host='localhost')
```
Once R is connected to the database, we can view and select necessary table from the database.
```{r}
ratings <- dbGetQuery(db, 'SELECT * FROM rating')
```
Let's see some information about the table and what's inside to check if data was imported correctly.
```{r}
summary(ratings)
head(ratings,n=5)
```


### 3. Data overview
From the data, we can gather some information about or movies and respondents.

Let's check who didn't watch watch which movie and didn't provide rating as well as which movie has the least number of views. As we see, Lucy was the one who didn't see almost all the movies. ORPHAN: FIRST KILL was the most unseen movie, Alex watched all six movies.
SQL:
```{mysql eval=FALSE}
SELECT *
FROM rating
WHERE rating IS NULL;
```
R:
```{r}
na_rating <- subset(ratings, is.na(ratings$rating))
na_rating 
```
Find average rating for each movie, put in descending order to see the best rated movie. We also need to ignore NULL values to make R calculate the average. It looks like SPIDER-MAN: NO WAY HOME is the best movie to watch at the current moment.
SQL:
```{mysql eval=FALSE}
SELECT movie_name, AVG(rating) AS rating_avg
FROM rating 
GROUP BY movie_name
ORDER BY rating DESC;
```

R:
```{r}
ratings %>%
  group_by(movie_name) %>%
  summarise_at(vars(rating), list(avg_rating = mean), na.rm=TRUE)  %>%
  arrange(desc(avg_rating))
```
Disconnect from database:
```{r}
on.exit(dbDisconnect(db))
```

### Conclusion
Using above steps, we have connected to the SQL database and imported it to R data frame. Using both, SQL and R, we did some research on the data: the best rated movie is $$\emph{Spider-Man: No Way Home}$$, don't watch $$\emph{Orphan: First Kill}$$, Lucy doesn't like to watch movies, Alex is in trend and watched all latest films.
